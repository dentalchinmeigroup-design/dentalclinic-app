import streamlit as st
import pandas as pd
from datetime import date
from streamlit_gsheets import GSheetsConnection

def main():
    st.set_page_config(page_title="å°ˆæ¥­æŠ€èƒ½è€ƒæ ¸è¡¨", layout="centered")
    st.title("æ—¥æ² â€§ å‹¤ç¾ â€§ å°æ—¥å­")
    st.subheader("ç·šä¸Šè€ƒæ ¸ç³»çµ± (é›²ç«¯é€£ç·šç‰ˆ)")

    # å»ºç«‹ Google Sheets é€£ç·š
    try:
        conn = st.connection("gsheets", type=GSheetsConnection)
    except Exception as e:
        st.error("é€£ç·šè¨­å®šå°šæœªå®Œæˆï¼Œè«‹æª¢æŸ¥ Streamlit Secrets è¨­å®šã€‚")
        st.stop()

    st.markdown("---")

    # --- 1. åŸºæœ¬è³‡æ–™ ---
    st.header("1. åŸºæœ¬è³‡æ–™")
    col1, col2 = st.columns(2)
    with col1:
        name = st.text_input("å§“å", placeholder="è«‹è¼¸å…¥å§“å")
        rank = st.text_input("è·ç­‰", placeholder="è«‹è¼¸å…¥è·ç­‰")
    with col2:
        assess_date = st.date_input("è©•é‡æ—¥æœŸ", date.today())
        manager = st.text_input("è€ƒæ ¸ä¸»ç®¡", placeholder="è«‹è¼¸å…¥ä¸»ç®¡å§“å")

    st.markdown("---")

    # --- NEW: è©•åˆ†æ¨™æº–èˆ‡æŒ‡æ¨™èªªæ˜ (æ•´åˆç‰ˆ) ---
    with st.expander("â„¹ï¸ é»æ­¤æŸ¥çœ‹ï¼šè©•åˆ†æ¨™æº– & æŒ‡æ¨™å®šç¾©èªªæ˜", expanded=False):
        tab1, tab2 = st.tabs(["ğŸ“Š è©•åˆ†æ¨™æº– (åˆ†æ•¸)", "ğŸ“– æŒ‡æ¨™å®šç¾©èªªæ˜ (æ–‡å­—)"])
        
        with tab1:
            st.markdown("""
            * **10åˆ† (è¶…è¶Šè¦æ±‚)**ï¼šè¡¨ç¾å“è¶Šã€‚
            * **8-9åˆ† (å®Œå…¨ç¬¦åˆ)**ï¼šåŸºæœ¬è¦æ±‚å®Œå…¨ç¬¦åˆï¼Œè¡¨ç¾ç©©å®šã€‚
            * **5-7åˆ† (éƒ¨åˆ†ç¬¦åˆ)**ï¼šä½†æœ‰å»ºè­°æ”¹å–„äº‹é …ã€‚
            * **3-4åˆ† (ä¸ç¬¦åˆ)**ï¼šé¦–æ¬¡åˆ—å…¥æ”¹å–„è¿½è¹¤ã€‚
            * **0-2åˆ† (å¤šæ¬¡ä¸ç¬¦åˆ)**ï¼šéœ€æŒçºŒæ”¹å–„è¿½è¹¤ã€‚
            * **N/A**ï¼šä¸é©ç”¨æ­¤é …ï¼Œä¸åˆ—å…¥è¨ˆç®—ã€‚
            """)
            
        with tab2:
            st.markdown("""
            | è©•æ ¸é¢å‘ | è€ƒæ ¸é‡é» | å°ˆæ¥­èƒ½åŠ›å®šç¾©èªªæ˜ |
            | :--- | :--- | :--- |
            | **å°ˆæ¥­æŠ€èƒ½** | | å…·å‚™è·å‹™æ‰€éœ€çš„å„é …å°ˆæ¥­çŸ¥è­˜èˆ‡æŠ€èƒ½ï¼Œèƒ½å……ä»½æ»¿è¶³å·¥ä½œéœ€æ±‚ã€‚ |
            | **æ ¸å¿ƒè·èƒ½** | **å‹¤å‹™é…åˆ** | éµå¾ªè¦ç¯„ï¼Œç¶­æŒè‰¯å¥½çš„å‡ºå‹¤ç´€å¾‹ï¼Œä¸¦èƒ½åœ¨å·¥ä½œä¸­å±•ç¾ç©æ¥µçš„æ…‹åº¦èˆ‡æŒçºŒé€²å–çš„ä¼åœ–å¿ƒã€‚ |
            | **æ ¸å¿ƒè·èƒ½** | **äººéš›å”ä½œ** | èˆ‡åŒå„•ä¿æŒè‰¯å¥½äº’å‹•ï¼Œå°Šé‡ä¸¦æœå¾ä¸Šä¸‹ç´šæŒ‡ç¤ºï¼Œå…·å‚™è‰¯å¥½çš„åœ˜éšŠåˆä½œèƒ½åŠ›ã€‚ |
            | **è¡Œæ”¿è·èƒ½** | **è·èƒ½èˆ‡æ‡‰è®Š** | 1. å…·å‚™ç¢ºä¿è¨ºæ‰€æ—¥å¸¸ç‡Ÿé‹ç©©å®šçš„å°ˆæ¥­èƒ½åŠ›ï¼Œèƒ½å®Œæˆè¡Œæ”¿èˆ‡æ”¯æ´å·¥ä½œï¼Œä¸¦æœ‰æ•ˆåŸ·è¡Œä¸»ç®¡äº¤è¾¦ä»»å‹™ã€‚<br>2. åŒæ™‚å…·å‚™é«˜åº¦æ‡‰è®Šèˆ‡å•é¡Œè§£æ±ºèƒ½åŠ›ï¼Œèƒ½å³æ™‚è™•ç†çªç™¼éœ€æ±‚ï¼Œä¸»å‹•æ”¯æ´ä¸¦å±•ç¾åœ˜éšŠåˆä½œç²¾ç¥ã€‚ |
            """)

    st.markdown("---")

    # --- 2. è©•åˆ†å…§å®¹ ---
    sections = {
        "å°ˆæ¥­æŠ€èƒ½": [
            ("è·Ÿè¨ºæŠ€èƒ½", "å™¨æ¢°æº–å‚™ç†Ÿç·´ï¼Œç„¡é‡å¤§ç¼ºå¤±ï¼›è€—æä¸è¶³èƒ½ç«‹å³è£œå……ã€‚"),
            ("æ«ƒå°æŠ€èƒ½", "æº–ç¢ºå®Œæˆç´„è¨ºã€å ±è¡¨èˆ‡æ«ƒæª¯è¡Œæ”¿ä½œæ¥­ã€‚")
        ],
        "æ ¸å¿ƒè·èƒ½": [
            ("è·Ÿè¨ºåŸ·è¡Œ", "ç¢ºä¿è¨ºç™‚ä¸ä¸­æ–·ï¼Œå³æ™‚æ”¯æ´é†«å¸«éœ€æ±‚ã€‚"),
            ("æ«ƒå°æºé€š", "èˆ‡é†«å¸«ã€ç—…äººæœ‰è‰¯å¥½é›™å‘æºé€šï¼›æ…‹åº¦è¦ªåˆ‡å°ˆæ¥­ã€‚"),
            ("å‹¤å‹™é…åˆ(è·èƒ½)", "éµå®ˆå‡ºå‹¤èˆ‡è«‹å‡è¦ç¯„ï¼Œé…åˆæ’ç­ã€‚"),
            ("å‹¤å‹™é…åˆ(é…åˆ)", "ç©æ¥µåƒèˆ‡ç‰™ç§‘è¨“ç·´èª²ç¨‹ï¼Œç¢ºå¯¦å‡ºå¸­ã€‚"),
            ("äººéš›å”ä½œ(äººéš›)", "æ—¥å¸¸èƒ½èˆ‡åŒå„•äº’åŠ©å¹«å¿™ï¼Œé«˜å³°æœŸä¸»å‹•æ”¯æ´ã€‚"),
            ("äººéš›å”ä½œ(å”ä½œ)", "å°Šé‡ä¸¦è½å¾å‰è¼©æŒ‡ç¤ºï¼Œå¸¶é ˜æ–°äººæ™‚å±•ç¾è‰¯å¥½æ…‹åº¦ã€‚")
        ],
        "è¡Œæ”¿è·èƒ½": [
            ("å±æ©Ÿè™•ç†", "èƒ½å³æ™‚è™•ç†çªç™¼äº‹ä»¶ï¼Œä¸»å‹•é é˜²å•é¡Œã€‚"),
            ("åŸºç¤è·èƒ½", "ç¢ºå¯¦å®Œæˆè¡Œæ”¿å·¥ä½œ(ç¶­ä¿®/ç‰™æ/ç‰™æ¨¡)ã€‚"),
            ("é€²éšè·èƒ½", "ç†è§£è¨ºæ‰€åŠè€é—†è¦æ±‚ï¼Œå¦¥å–„æ•ˆç‡å®Œæˆä»»å‹™ã€‚"),
            ("æ‡‰è®Šèƒ½åŠ›", "å› æ‡‰è€é—†è‡¨æ™‚éœ€æ±‚ï¼Œå±•ç¾éˆæ´»æ…‹åº¦ã€‚")
        ]
    }

    scores_data = {}
    for category, items in sections.items():
        st.subheader(f"ğŸ“Œ {category}")
        for title, desc in items:
            st.caption(f"{title}: {desc}")
            score = st.slider(f"è©•åˆ† ({title})", 0, 10, 8, key=f"{category}_{title}")
            scores_data[f"{category}-{title}"] = score
        st.markdown("---")

    # --- 3. è©•èªèˆ‡æäº¤ ---
    st.header("ğŸ“ è©•èªèˆ‡å»ºè­°")
    self_eval = st.text_area("åŒä»è‡ªè©•")
    manager_eval = st.text_area("ä¸»ç®¡è©•èª")
    action = st.selectbox("è€ƒæ ¸å»ºè­°", ["é€šé", "éœ€è§€å¯Ÿ", "éœ€è¼”å°", "å·¥ä½œèª¿æ•´", "å…¶ä»–"])

    if st.button("ğŸš€ æäº¤è€ƒæ ¸çµæœ", type="primary"):
        if not name:
            st.error("è«‹å‹™å¿…å¡«å¯«å§“åï¼")
        else:
            with st.spinner("æ­£åœ¨å¯«å…¥é›²ç«¯è³‡æ–™åº«..."):
                # è¨ˆç®—å¹³å‡
                avg_score = sum(scores_data.values()) / len(scores_data)
                
                # æº–å‚™è³‡æ–™
                row = {
                    "å§“å": name,
                    "è·ç­‰": rank,
                    "æ—¥æœŸ": assess_date.strftime("%Y-%m-%d"),
                    "è€ƒæ ¸ä¸»ç®¡": manager,
                    "ç¸½å¹³å‡": f"{avg_score:.2f}",
                    "åŒä»è‡ªè©•": self_eval,
                    "ä¸»ç®¡è©•èª": manager_eval,
                    "è€ƒæ ¸å»ºè­°": action,
                    "å¡«å¯«æ™‚é–“": pd.Timestamp.now().strftime("%Y-%m-%d %H:%M:%S")
                }
                row.update(scores_data)
                new_df = pd.DataFrame([row])

                # å¯«å…¥ Google Sheets
                try:
                    existing_data = conn.read(worksheet="Sheet1", ttl=0)
                    updated_df = pd.concat([existing_data, new_df], ignore_index=True)
                except:
                    updated_df = new_df

                conn.update(worksheet="Sheet1", data=updated_df)
                
                st.success(f"âœ… æˆåŠŸï¼{name} çš„è³‡æ–™å·²å­˜å…¥é›²ç«¯ã€‚")
                st.balloons()

if __name__ == "__main__":
    main()
