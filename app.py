import streamlit as st
import pandas as pd
from datetime import date
import io

def main():
    # è¨­å®šç¶²é æ¨™é¡Œèˆ‡æ’ç‰ˆ
    st.set_page_config(page_title="å°ˆæ¥­æŠ€èƒ½è€ƒæ ¸è¡¨", layout="centered")
    
    st.title("æ—¥æ² â€§ å‹¤ç¾ â€§ å°æ—¥å­")
    st.subheader("å°ˆæ¥­æŠ€èƒ½è€ƒæ ¸è¡¨")
    st.markdown("---")

    # --- 1. åŸºæœ¬è³‡æ–™å€ ---
    st.header("1. åŸºæœ¬è³‡æ–™")
    col1, col2 = st.columns(2)
    with col1:
        name = st.text_input("å§“å", placeholder="è«‹è¼¸å…¥å§“å")
        rank = st.text_input("è·ç­‰", placeholder="è«‹è¼¸å…¥è·ç­‰")
    with col2:
        assess_date = st.date_input("è©•é‡æ—¥æœŸ", date.today())
        manager = st.text_input("è€ƒæ ¸ä¸»ç®¡", placeholder="è«‹è¼¸å…¥ä¸»ç®¡å§“å")

    st.markdown("---")

    # --- 2. è©•åˆ†æ¨™æº–èªªæ˜ ---
    with st.expander("â„¹ï¸ é»æ­¤æŸ¥çœ‹è©•åˆ†æ¨™æº–èªªæ˜ (è«‹å±•é–‹)", expanded=False):
        st.markdown("""
        * **10åˆ† (è¶…è¶Šè¦æ±‚)**ï¼šè¡¨ç¾å“è¶Šã€‚
        * **8-9åˆ† (å®Œå…¨ç¬¦åˆ)**ï¼šåŸºæœ¬è¦æ±‚å®Œå…¨ç¬¦åˆï¼Œè¡¨ç¾ç©©å®šã€‚
        * **5-7åˆ† (éƒ¨åˆ†ç¬¦åˆ)**ï¼šä½†æœ‰å»ºè­°æ”¹å–„äº‹é …ã€‚
        * **3-4åˆ† (ä¸ç¬¦åˆ)**ï¼šé¦–æ¬¡åˆ—å…¥æ”¹å–„è¿½è¹¤ã€‚
        * **0-2åˆ† (å¤šæ¬¡ä¸ç¬¦åˆ)**ï¼šéœ€æŒçºŒæ”¹å–„è¿½è¹¤ã€‚
        * **N/A**ï¼šä¸é©ç”¨æ­¤é …ï¼Œä¸åˆ—å…¥è¨ˆç®—ã€‚
        """)

    # --- 3. è€ƒæ ¸é …ç›®å®šç¾© ---
    # çµæ§‹ï¼š(å¤§é¡åˆ¥, å­é …ç›®æ¨™é¡Œ, è©³ç´°èªªæ˜å…§å®¹)
    sections = {
        "å°ˆæ¥­æŠ€èƒ½": [
            ("è·Ÿè¨ºæŠ€èƒ½", "å™¨æ¢°èˆ‡è¨ºé–“æº–å‚™ï¼Œä¾ç…§SOPæ“ä½œï¼Œå™¨æ¢°æº–å‚™ç†Ÿç·´ï¼Œç„¡é‡å¤§ç¼ºå¤±ï¼›è€—æä¸è¶³èƒ½ç«‹å³è£œå……ã€‚"),
            ("æ«ƒå°æŠ€èƒ½", "æº–ç¢ºå®Œæˆç´„è¨ºã€å ±è¡¨èˆ‡æ«ƒæª¯è¡Œæ”¿ä½œæ¥­ï¼Œç¢ºä¿è³‡æ–™æ­£ç¢ºç„¡èª¤ã€‚")
        ],
        "æ ¸å¿ƒè·èƒ½": [
            ("è·Ÿè¨ºåŸ·è¡Œ", "æ­£ç¢ºåŸ·è¡Œç¢ºä¿è¨ºç™‚ä¸ä¸­æ–·ï¼Œå³æ™‚æ”¯æ´é†«å¸«éœ€æ±‚ã€ç¶­æŒçœ‹è¨ºæµæš¢èˆ‡ç—…æ‚£èˆ’é©ã€‚"),
            ("æ«ƒå°æºé€š", "èˆ‡é†«å¸«ã€ç—…äººæœ‰è‰¯å¥½é›™å‘æºé€šï¼›æ­£ç¢ºå‚³é”è³‡è¨Šï¼›æ…‹åº¦è¦ªåˆ‡å°ˆæ¥­ã€‚"),
            ("å‹¤å‹™é…åˆ(è·èƒ½)", "éµå®ˆå‡ºå‹¤èˆ‡è«‹å‡è¦ç¯„ï¼Œé…åˆæ’ç­ä¸¦ä¸»å‹•å”èª¿ä¸Šç­æ™‚æ®µï¼Œç¢ºä¿è¨ºæ‰€ç‡Ÿé‹æ­£å¸¸ã€‚"),
            ("å‹¤å‹™é…åˆ(é…åˆ)", "ç©æ¥µåƒèˆ‡ç‰™ç§‘è¨“ç·´èª²ç¨‹ï¼Œç¢ºå¯¦å‡ºå¸­ä¸¦å°‡æ‰€å­¸æ‡‰ç”¨æ–¼å·¥ä½œã€‚"),
            ("äººéš›å”ä½œ(äººéš›)", "æ—¥å¸¸èƒ½èˆ‡åŒå„•äº’åŠ©å¹«å¿™ã€‚è¨ºæ‰€é«˜å³°æœŸä¸»å‹•æ”¯æ´åŒäº‹ï¼Œå±•ç¾è·¨ç«™å”ä½œï¼Œç¢ºä¿æµç¨‹é †æš¢ã€‚"),
            ("äººéš›å”ä½œ(å”ä½œ)", "èƒ½å°Šé‡ä¸¦è½å¾å‰è¼©æŒ‡ç¤ºã€ä¿æŒå‹å¥½äº’å‹•ï¼Œä¸¦åœ¨å¸¶é ˜æ–°äººæ™‚å±•ç¾è‰¯å¥½æ…‹åº¦èˆ‡æŒ‡å°èƒ½åŠ›ã€‚")
        ],
        "è¡Œæ”¿è·èƒ½": [
            ("å±æ©Ÿè™•ç†/åœ˜éšŠåƒèˆ‡", "èƒ½å³æ™‚è™•ç†å„ç¨®çªç™¼äº‹ä»¶ï¼Œä¸¦ä¸»å‹•é é˜²å•é¡Œå†æ¬¡ç™¼ç”Ÿï¼›ä¸»å‹•åƒåŠ è¨ºæ‰€æ´»å‹•ï¼Œå±•ç¾å‘å¿ƒåŠ›ã€‚"),
            ("åŸºç¤è·èƒ½", "èƒ½ç¢ºå¯¦å®Œæˆè¡Œæ”¿å·¥ä½œï¼Œå¦‚ï¼šç¶­ä¿®ã€ç‰™æã€ç‰™æ¨¡ç­‰ç­‰ï¼Œç¢ºä¿è¨ºæ‰€é‹ä½œç©©å®šã€‚"),
            ("é€²éšè·èƒ½", "èƒ½ç†è§£è¨ºæ‰€åŠè€é—†çš„å·¥ä½œè¦æ±‚ï¼Œå¦¥å–„æ•ˆç‡å®Œæˆäº¤è¾¦ä»»å‹™ã€‚"),
            ("æ‡‰è®Šèƒ½åŠ›", "èƒ½å› æ‡‰è€é—†å„ç¨®è‡¨æ™‚éœ€æ±‚ï¼Œå±•ç¾éˆæ´»èˆ‡éš¨æ™‚æŠ•å…¥çš„æ…‹åº¦ã€‚")
        ]
    }

    # --- 4. å‹•æ…‹ç”Ÿæˆè©•åˆ†è¡¨å–® ---
    scores_data = {}  # å„²å­˜åˆ†æ•¸
    
    for category, items in sections.items():
        st.header(f"ğŸ“Œ {category}")
        for title, desc in items:
            st.markdown(f"**{title}**")
            st.caption(f"èªªæ˜ï¼š{desc}")
            
            # ä½¿ç”¨ radio button æ¨¡æ“¬ N/A é¸é …ï¼Œæˆ–ä½¿ç”¨ slider
            # é€™è£¡è¨­è¨ˆä¸€å€‹æ··åˆä»‹é¢ï¼šå…ˆé¸æ˜¯å¦æœ‰åˆ†æ•¸
            is_na = st.checkbox(f"æ­¤é …ç›®ä¸é©ç”¨ (N/A) - {title}", key=f"na_{title}")
            
            if not is_na:
                score = st.slider(f"è©•åˆ† ({title})", 0, 10, 8, key=f"slider_{title}")
                scores_data[f"{category}-{title}"] = score
            else:
                scores_data[f"{category}-{title}"] = "N/A"
            st.markdown("---")

    # --- 5. è³ªæ€§è©•èªèˆ‡å»ºè­° ---
    st.header("ğŸ“ è‡ªè©•èˆ‡ä¸»ç®¡è©•èª")
    
    col_text1, col_text2 = st.columns(2)
    with col_text1:
        self_eval = st.text_area("åŒä»è‡ªè©•", placeholder="è«‹è‡ªè¿°å…·é«”è¡¨ç¾æˆ–æª¢è¨æ”¹é€²äº‹ä¾‹...", height=150)
    with col_text2:
        manager_eval_1 = st.text_area("åˆè€ƒä¸»ç®¡è©•èª", placeholder="è«‹åˆ—èˆ‰å…·é«”è¡¨ç¾äº‹ä¾‹æˆ–æ”¹é€²å»ºè­°...", height=150)
        manager_eval_2 = st.text_area("è¦†è€ƒä¸»ç®¡è©•èª", placeholder="è¦†è€ƒå»ºè­°...", height=100)

    st.subheader("è€ƒæ ¸çµæœå»ºè­°")
    action_type = st.radio("å»ºè­°äº‹é …", 
             ["é€šé", "éœ€è¦å†æºé€šä»¥è§€å¾Œæ•ˆ", "éœ€è¦è¨“ç·´èˆ‡è¼”å°", "å·¥ä½œèª¿æ•´", "å…¶ä»–"])
    
    action_detail = ""
    if action_type == "éœ€è¦å†æºé€šä»¥è§€å¾Œæ•ˆ":
        action_detail = st.date_input("ä¸‹æ¬¡é¢è«‡æ™‚é–“").strftime("%Y-%m-%d")
    elif action_type == "éœ€è¦è¨“ç·´èˆ‡è¼”å°":
        action_detail = st.text_input("è¨»æ˜å…§å®¹åŠé ä¼°æ‰€éœ€æ™‚é–“")
    elif action_type == "å·¥ä½œèª¿æ•´" or action_type == "å…¶ä»–":
        action_detail = st.text_input("èªªæ˜")

    # --- 6. æäº¤èˆ‡è¨ˆç®— ---
    submit_btn = st.button("âœ… å®Œæˆä¸¦ç”Ÿæˆå ±è¡¨", type="primary")

    if submit_btn:
        if not name:
            st.error("è«‹å¡«å¯«å§“åï¼")
        else:
            # è¨ˆç®—å¹³å‡åˆ† (æ’é™¤ N/A)
            valid_scores = [v for v in scores_data.values() if isinstance(v, int)]
            if valid_scores:
                avg_score = sum(valid_scores) / len(valid_scores)
            else:
                avg_score = 0

            st.success(f"è€ƒæ ¸å®Œæˆï¼ {name} çš„å¹³å‡åˆ†æ•¸ç‚ºï¼š{avg_score:.2f}")

            # æº–å‚™ä¸‹è¼‰è³‡æ–™
            final_data = {
                "å§“å": name,
                "è·ç­‰": rank,
                "æ—¥æœŸ": assess_date,
                "è€ƒæ ¸ä¸»ç®¡": manager,
                "ç¸½å¹³å‡": f"{avg_score:.2f}",
                "åŒä»è‡ªè©•": self_eval,
                "åˆè€ƒè©•èª": manager_eval_1,
                "è¦†è€ƒè©•èª": manager_eval_2,
                "è€ƒæ ¸å»ºè­°": f"{action_type} {action_detail}",
            }
            # åŠ å…¥ç´°é …åˆ†æ•¸
            final_data.update(scores_data)

            # è½‰ç‚º DataFrame
            df = pd.DataFrame([final_data])
            
            # é¡¯ç¤ºçµæœé è¦½
            st.dataframe(df)

            # è£½ä½œ CSV ä¸‹è¼‰æŒ‰éˆ• (è§£æ±ºä¸­æ–‡äº‚ç¢¼å•é¡Œï¼Œä½¿ç”¨ utf-8-sig)
            csv = df.to_csv(index=False).encode('utf-8-sig')
            st.download_button(
                label="ğŸ“¥ ä¸‹è¼‰è€ƒæ ¸çµæœ (CSV)",
                data=csv,
                file_name=f"{name}_{assess_date}_è€ƒæ ¸è¡¨.csv",
                mime="text/csv"
            )

if __name__ == "__main__":
    main()
